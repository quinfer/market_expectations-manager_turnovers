---
title: "Market Expectations and Mangerial Turnover"
author: 
  - Ronan Gallagher
  - Barry Quinn
format: 
    pdf:
      fig-pos: "H"
bibliography: references.bib
execute: 
  echo: false
  warning: false
  message: false
---

```{r}
#| include: false
rm(list = ls())
library(brms)
library(tidyverse)
library(rstan)
library (tidybayes)
#reticulate::use_condaenv("pymc")

logit_baseline<-readRDS("models/logit_poach_base.rds")
hazard_cty<-readRDS("models/grp_lvl_poach_cty.rds")
hazard_season<-readRDS("models/grp_lvl_poach_season.rds")
hazard_div <- readRDS("models/grp_lvl_poach_div.rds")
logit_cty <-readRDS("models/logit_grp_lvl_poach_cty.rds")
logit_div <- readRDS("models/logit_grp_lvl_poach_div.rds")
logit_season <- readRDS("models/logit_grp_lvl_poach_season.rds")

logit_baseline |> 
  spread_draws(b_Standardized_CumRS,b_Pct_of_Possible_Points_Won)->logit_baseline

hazard_div |>   
  spread_draws(r_Div[Division,Variable]) |>
  pivot_wider(names_from = Variable,values_from = r_Div) |>
  left_join(hazard_div 
            |> spread_draws(b_Standardized_CumRS,b_Pct_of_Possible_Points_Won),
            by=c(".chain",'.iteration')) |>
  mutate(conditional_mean_CumRS=b_Standardized_CumRS+Intercept+Standardized_CumRS,
         conditional_mean_Pcts_of_Possible=b_Pct_of_Possible_Points_Won +
           Intercept+Pct_of_Possible_Points_Won) -> hazard_div 

logit_div |>   
  spread_draws(r_Div[Division,Variable]) |>
  pivot_wider(names_from = Variable,values_from = r_Div) |>
  left_join(logit_div |> 
              spread_draws(b_Standardized_CumRS,b_Pct_of_Possible_Points_Won),
            by=c(".chain",'.iteration')) |>
  mutate(conditional_mean_CumRS=b_Standardized_CumRS+Intercept+Standardized_CumRS,
         conditional_mean_Pcts_of_Possible=b_Pct_of_Possible_Points_Won+
           Intercept+Pct_of_Possible_Points_Won) -> logit_div 

hazard_cty |>
  spread_draws(r_country[Country,Variable]) |>
  pivot_wider(names_from = Variable,values_from = r_country) |>
  left_join(hazard_cty |> spread_draws(b_Standardized_CumRS,b_Pct_of_Possible_Points_Won),
            by=c(".chain",'.iteration')) |>
  mutate(conditional_mean_CumRS=b_Standardized_CumRS+Intercept+Standardized_CumRS,
         conditional_mean_Pcts_of_Possible=b_Pct_of_Possible_Points_Won+
           Intercept+Pct_of_Possible_Points_Won) -> hazard_cty

logit_cty |>
  spread_draws(r_country[Country,Variable]) |>
  pivot_wider(names_from = Variable,values_from =r_country) |>
  left_join(logit_cty |> spread_draws(b_Standardized_CumRS,b_Pct_of_Possible_Points_Won),
            by=c(".chain",'.iteration')) |>
  mutate(conditional_mean_CumRS=b_Standardized_CumRS+Intercept+Standardized_CumRS,
         conditional_mean_Pcts_of_Possible=b_Pct_of_Possible_Points_Won+
           Intercept+Pct_of_Possible_Points_Won) -> logit_cty
  
hazard_season |>
  spread_draws(r_Season[Season,Variable]) |>
  pivot_wider(names_from = Variable,values_from = r_Season) |>
  left_join(hazard_season |> spread_draws(b_Standardized_CumRS,b_Pct_of_Possible_Points_Won),
            by=c(".chain",'.iteration')) |>
  mutate(conditional_mean_CumRS=b_Standardized_CumRS+Intercept+Standardized_CumRS,
         conditional_mean_Pcts_of_Possible=b_Pct_of_Possible_Points_Won+
           Intercept+Pct_of_Possible_Points_Won) -> hazard_season

logit_season |>
  spread_draws(r_Season[Season,Variable]) |>
  pivot_wider(names_from = Variable,values_from = r_Season) |>
  left_join(logit_season |> spread_draws(b_Standardized_CumRS,b_Pct_of_Possible_Points_Won),by=c(".chain",'.iteration')) |>
  mutate(conditional_mean_CumRS=b_Standardized_CumRS+Intercept+Standardized_CumRS,
         conditional_mean_Pcts_of_Possible=b_Pct_of_Possible_Points_Won+Intercept+Pct_of_Possible_Points_Won) -> logit_season
  
```

```{r}
# Creating the named vector in R
cty_factor_vector <- c('E' = "England", 'SP' = "Spain", 'SC' = "Scotland", 'I' = "Italy",
                    'F' = "France", 'D' = "Germany", 'P' = "Portugal", 
                    'N' = "Netherlands", 'T' = "Turkey", 'G' = "Greece", 
                    'B' = "Belgium")
# Assuming df$factor_var is your factor variable
logit_cty$cty_factor <- factor(logit_cty$Country, labels = cty_factor_vector)
hazard_cty$cty_factor <- factor(hazard_cty$Country, labels = cty_factor_vector)
```

# Introduction

# Literature

Here is the updated literature review with the corporate CEO turnover papers included in the summary table:

Managerial turnover in professional association football (soccer) has been a subject of significant interest among researchers in sports economics and management, drawing parallels with the corporate world. The high-stakes nature of the sport, coupled with the intense pressure to perform, has led to a high rate of managerial dismissals and voluntary departures, similar to the dynamics observed in CEO turnover and firm performance. This literature review synthesises the existing research on the determinants and consequences of managerial turnover in professional football, incorporating insights from the corporate context.

Numerous studies have investigated the relationship between organisational performance and managerial turnover in football, mirroring the negative correlation between poor organizational performance and involuntary CEO dismissal \cite{defond1999effect}. Audas, Dobson, and Goddard \cite{audas2000organizational} analysed managerial job-termination hazard functions in English professional soccer from 1972 to 1997, covering 2,365 managerial spells, and found that short-term fluctuations in performance strongly influence the involuntary termination hazard, which is also heavily dependent on the team's current league position relative to its position when the manager took charge and the win ratio over the entire spell. The same authors \cite{audas2000team} also investigated the relationship between team performance and managerial change in the English Football League between 1972 and 1993, examining 1,531 managerial spells, revealing that poor recent form drives many managerial terminations, whilst managerial turnover is more rapid in the lower divisions.

Performance expectations play a significant role in managerial dismissals, both in the corporate world and in professional football. Boards of directors in the corporate world assess leaders against firm-specific expectations, benchmarking actual versus anticipated outcomes and attributing divergence to the CEO \cite{greve1998performance,defond1999effect,wiersema2011ceo}. Similarly, football clubs evaluate managers based on their ability to meet performance expectations. Allen et al. \cite{allen2012performance} investigated this question theoretically and empirically in the context of the National Football League (NFL), analyzing 477 coach-year observations from 1978 to 2005, finding that the probability of coach dismissal increased in the post-salary cap era and that concrete measures of an organisation's player talent, coaching talent, and on-field performance gained importance as determinants of turnover, indicative of increased expectations. Pieper, NÃ¼esch, and Franck \cite{pieper2014performance} examined 2,680 coach-game observations from the German Bundesliga between 1993 and 2010, showing that a one-standard-deviation increase in performance expectations nearly doubles the coach's dismissal probability, controlling for team performance and unobserved team heterogeneity.

The concept of strategic expectations management, wherein CEOs influence external stakeholder interpretations and shape performance benchmarks \cite{westphal2010matter,westphal2011avoiding}, can also be applied to football managers. Managers may use tactics such as injury pronouncements and other excuses to deflect responsibility and manage expectations. However, evidence remains limited regarding the precise managerial tactics used in this context \cite{pieper2014performance}.

Social media pressure and coach characteristics have also been identified as factors influencing managerial turnover. Attie et al. \cite{attie2023getting} proposed machine learning models to characterise the determinants of managerial dismissals, utilizing data from the English Premier League, finding that social media pressure from fans on Twitter is associated with managerial sacking, alongside traditional football statistics. Semmelroth et al. \cite{semmelroth2021time} investigated the determinants of voluntary and involuntary head coach turnovers in Major League Soccer (MLS) from 2004 to 2019, analyzing 6,584 coach-game observations, revealing that coach reputation decreases dismissal probabilities, whilst coach age increases quit rates. Additionally, Bell, Brooks, and Markham \cite{bell2013performance} investigated the sacking of managers in the English Premier League from 1992 to 2012, examining 60 managerial dismissals, finding that a higher total wage bill, a lower win percentage, and a lower position in the league table all increase the probability of a manager being sacked.

The consequences of managerial turnover on team performance have been a subject of debate in the literature. Audas, Dobson, and Goddard \cite{audas2000team} found that managerial change appears to have a harmful effect on team performance immediately following a managerial termination in the English Football League. Tena and Forrest \cite{tena2007within} examined the consequences of within-season dismissals of managers in the top division of the Spanish Football League from 2002 to 2005, covering 132 managerial changes, demonstrating that an improvement in results tended to be achieved but only in home matches, suggesting that appeasing fans can have on-the-field benefits. However, Van Ours and van Tuijl \cite{van2015season} studied the causes and consequences of in-season changes of head coaches in Dutch professional football, analyzing 578 managerial spells between 1986 and 2004, and concluded that the replacement of head coaches does not improve team performance, as the performance of a control group of coach replacements that did not occur also improved. Similarly, Flores, Forrest, and Tena \cite{flores2012decision} investigated football manager dismissals in Argentina, examining 1,995 matches from 2005 to 2008, and detected a tendency for a change of manager to be followed by deterioration in team performance, consistent with decisions being driven by fan and media pressure rather than a realistic hope of improving the club's position. Bruinshoofd and ter Weel \cite{bruinshoofd2003manager} also examined the effectiveness of manager dismissals in Dutch football, covering 12 seasons from 1988 to 2000, and suggested that sacking a manager is neither effective nor efficient in terms of improving team performance.

Several studies have investigated the factors influencing managerial survival in football. Barros, Frick, and Passos \cite{barros2009coaching} analysed how long head coaches survive in the clubs of the German Bundesliga, covering 398 managerial spells from 1981 to 2003, finding that head coaches of successful teams and those working during the more recent 'Bosman Effect' period are more likely to survive, whilst head coaches of clubs with relatively high team wage bills are likely to survive for shorter periods. D'Addona and Kind \cite{daddona2014forced} conducted an empirical analysis of manager turnover in the four major English leagues from 1949 to 2008, examining 2,376 managerial changes, revealing that both the absolute frequency and the sensitivity of firing decisions on the outcome of recent matches steadily and significantly increased during the six decades covered by the sample, reflecting the increased level of competition and economic importance of the English soccer leagues.

Bachan, Reilly, and Witt \cite{bachan2005hazard} employed a longitudinal approach in modeling seasonal hazard rates and determining the importance of league position in predicting managerial survival, utilizing data from the English Football League covering three seasons from 2001 to 2004. Their findings emphasize the significance of team performance in shaping managerial turnover decisions. Additionally, the work of Koning \cite{koning2003econometric}, Forrest and Simmons \cite{forrest2000behaviour}, and others regarding the short-term impact of managerial change on team performance highlights the complex dynamics of post-turnover outcomes.

Tena and Forrest \cite{tena2007within} provide valuable insights into the role of financial relegation risks and failing historical powers as motivational factors for managerial turnover. Their findings suggest that the threat of relegation escalates turnover incidence, while the performance of historically successful clubs proves less significant in driving dismissal decisions.

Further research has delved into the effectiveness of in-season coach changes and the impact of managerial turnover on player performance. Besters, van Ours, and van Tuijl \cite{besters2016effectiveness} studied the effectiveness of in-season coach changes in Dutch football, examining 18 seasons from 1986 to 2004, considering the heterogeneity of coach ability and suggesting that coach ability is an important factor in determining team performance. Muehlheusser, Schneemann, and Sliwka \cite{muehlheusser2016impact} analysed the impact of managerial turnover on player performance in German football, utilizing data from the German Bundesliga covering six seasons from 2007 to 2013, showing that a coach dismissal is typically followed by an increase in the number of yellow and red cards, indicating that players exert more effort under the new coach, possibly to impress and secure their position in the team.

In conclusion, the literature on managerial turnover in professional association football highlights the complex interplay of factors that influence dismissals and voluntary departures, including organisational and team performance, performance expectations, social media pressure, and coach characteristics. The consequences of managerial change on team performance remain a subject of debate, with some studies suggesting short-term improvements and others indicating no significant effect or even deterioration in performance. The parallels drawn between the corporate world and professional football provide valuable insights into the dynamics of managerial turnover and its determinants. Further research could explore the long-term consequences of managerial turnover, the impact of managerial change on player motivation and performance, and the role of media scrutiny and fan sentiment in driving dismissal decisions. As the football industry continues to evolve, with increasing financial stakes and global attention, understanding the dynamics of managerial turnover will remain a critical area of inquiry for sports economists and management researchers.

Summary Table of References
| Authors                             | Year | Journal                                     | Country     | Focus                                                                                              |
|-------------------------------------|------|---------------------------------------------|-------------|---------------------------------------------------------------------------------------------------- |
| DeFond & Park                       | 1999 | The Accounting Review                       | USA         | Poor organizational performance and involuntary CEO dismissal                                      |
| Greve                               | 1998 | Strategic Management Journal                | USA         | Firm performance and CEO turnover                                                                  |
| Wiersema & Zhang                    | 2011 | Strategic Management Journal                | USA         | CEO dismissal and firm-specific performance expectations                                           |
| Westphal & Deephouse                | 2010 | Administrative Science Quarterly            | USA         | CEO influence on external stakeholder interpretations                                              |
| Westphal & Zajac                    | 2011 | Administrative Science Quarterly            | USA         | CEO influence on external stakeholder interpretations                                              |
| Audas, Dobson, & Goddard            | 2000 | Managerial and Decision Economics           | England     | Organisational performance and managerial turnover                                                 |
| Audas, Dobson, & Goddard            | 2000 | Economic Affairs                            | England     | Team performance and managerial change                                                             |
| Frick, Barros, & Prinz              | 2010 | European Journal of Operational Research    | Germany     | Head coach dismissals in the German Bundesliga                                                     |
| Allen, Panian, & Lotz               | 2012 | Journal of Sports Economics                 | USA         | Performance expectations and managerial dismissal in the NFL                                       |
| Attie, West, McDermott, & Luque     | 2023 | Complex Networks XIV                        | England     | Predicting managerial dismissals using social media pressure                                       |
| Semmelroth, Deutscher, & Orlowski    | 2021 | Journal of Sports Economics                 | USA         | Coach dismissals and quits in Major League Soccer                                                  |
| Van Ours & van Tuijl                | 2015 | Economic Inquiry                            | Netherlands | In-season head coach dismissals and team performance                                               |
| Tena & Forrest                      | 2007 | European Journal of Operational Research    | Spain       | Within-season dismissal of football coaches                                                        |
| Bachan, Reilly, & Witt              | 2008 | Journal of the Operational Research Society | England     | Hazard of being an English football league manager                                                 |
| Barros, Frick, & Passos             | 2009 | Applied Economics                           | Germany     | Coaching survival in the German Bundesliga                                                         |
| d'Addona & Kind                     | 2014 | Journal of Sports Economics                 | England     | Long-term perspective on forced manager turnover                                                   |
| Pieper, NÃ¼esch, & Franck            | 2014 | Schmalenbach Business Review                | Germany     | Performance expectations and managerial replacement decisions                                      |
| Flores, Forrest, & Tena             | 2012 | European Journal of Operational Research    | Argentina   | Football manager dismissals and consequences in Argentina                                          |
| Bruinshoofd & ter Weel              | 2003 | European Journal of Operational Research    | Netherlands | Manager dismissals and performance dips in Dutch football                                          |
| Holmes, Nowell, & Scelles           | 2010 | Journal of Sports Economics                 | USA         | College football coach dismissals                                                                  |
| Bell, Brooks, & Markham             | 2013 | Economics & Finance Research                | England     | Managerial sacking in the English Premier League                                                   |
| Besters, van Ours, & van Tuijl      | 2016 | De Economist                                | Netherlands | Effectiveness of in-season manager changes considering coach ability                               |
| Muehlheusser, Schneemann, & Sliwka | 2016 | Economic Inquiry                            | Germany     | Impact of managerial change on player performance                                                  |
: Summary of literature

# Data

## Manager spell

We build a hand-craft database on the complete manager turnover profiles of all professional football managers across 11 European leagues for 23 playing seasons up to 2023-2024. We use three sources 1. [league of managers association](https://leaguemanagers.com) a body representing professional managers in English football. 2. [Soccer base](https://www.soccerbase.com) a betting website 3. [Transfermkt website](https://www.transfermarkt.co.uk) a large website which records manager, player and team profiles as well as a large array of analytics of the valuation of playing staff. The raw data is gathered using a series of web scrapping algorithms. Our primary source of information is Transfermkt, but we use other sources to validate these manager spells.

```{r}
library(dplyr)
library(purrr)
#spells <- read.csv("raw_data/manager_spells_from_manager_urls_mgronly.csv")
spells <- readRDS("raw_data/manager_spells_from_manager_urls.rds")
```

The raw data from transfrmarkt is then cleaned and processed to create a raw dataset of manager spells. The dataset contains the following columns:

-   `name`: The name of of staff member
-   `club`: The club of the staff member
-   `position`: The position of the staff member
-   `appointed`: The start date of the spell
-   `contract_expiry`: The end date of the spell
-   `days_in_charge`: The number of days the manager was in charge of the club
-   `wins`: Number of wins for spell
-   `draws`: Number of draws for spell
-   `losses`: Number of losses for spell
-   `players_used`: Number of players used in the spell
-   `avg_goals_for`: Average goals scored per game
-   `avg_goals_against`: Average goals conceded per game
-    `ppm`: Points per match



```{r}
#|label: tbl-managertype
#| tbl-cap: "Manager types"
library(kableExtra)
spells %>%
  {table(.$staff_position[!is.na(.$staff_position)])} |> sort(decreasing = TRUE) |> 
  # make the frequency table into a data frame
  as.data.frame() |>
  # rename the columns
  rename("staff_position" = "Var1", "n" = "Freq") |>
  # order the data frame by the frequency
  arrange(desc(n)) |>
  head(20) |>
  kable(col.names=c("Staff Role","Number")) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F)
```



```{r}
#| label: fig-annual-spell-count
#| fig-cap: "Annual count of manager spell ending"
library(ggplot2)
library(dplyr)
# create plot of annual count of spells using a count of finishes per season assume season starts in August
spells |> 
  mutate(youth_team = ifelse(str_detect(club, "[A-Z][0-9]{2}|Yth.|Youth"), "Yes", "No")) -> spells

# create a list of european countries
european_countries <- c("albania", "andorra", "austria", "belarus", "belgium", "bosnia-herzegovina", "bulgaria", "croatia", "cyprus", "czech-republic", "denmark", "estonia", "faroe-islands", "finland", "france", "germany", "gibraltar", "greece", "hungary", "iceland", "ireland", "italy", "kosovo", "latvia", "liechtenstein", "lithuania", "luxembourg", "malta", "moldova", "montenegro", "netherlands", "north-macedonia", "northern-ireland", "norway", "poland", "portugal", "romania", "russia", "san-marino", "scotland", "serbia", "slovakia", "slovenia", "spain", "sweden", "switzerland", "turkey", "ukraine", "wales", "england")
# Create a list of north and south american countries
north_american_countries <- c("canada", "mexico", "united-states","USA")
# list of central american countries
central_american_countries <- c("belize", "costa-rica", "el-salvador", "guatemala", "honduras", "nicaragua", "panama")
south_american_countries <- c("argentina", "bolivia", "brazil", "chile", "colombia", "ecuador", "paraguay", "peru", "uruguay", "venezuela")
# Create list of australiasian countries
australasian_countries <- c("australia", "fiji", "new-zealand", "papua-new-guinea", "solomon-islands", "vanuatu")
# Create list of african countries
african_countries <- c("algeria", "angola", "benin", "botswana", "burkina-faso", "burundi", "cameroon", "cape-verde", "central-african-republic", "chad", "comoros", "congo", "djibouti", "egypt", "equatorial-guinea", "eritrea", "eswatini", "ethiopia", "gabon", "gambia", "ghana", "guinea", "guinea-bissau", "ivory-coast", "kenya", "lesotho", "liberia", "libya", "madagascar", "malawi", "mali", "mauritania", "mauritius", "morocco", "mozambique", "namibia", "niger", "nigeria", "rwanda", "sao-tome-and-principe", "senegal", "seychelles", "sierra-leone", "somalia", "south-africa", "south-sudan", "sudan", "tanzania", "togo", "tunisia", "uganda", "zambia", "zimbabwe")
# Create list of asian countries
asian_countries <- c("afghanistan", "armenia", "azerbaijan", "bahrain", "bangladesh", "bhutan", "brunei", "cambodia", "china", "east-timor", "georgia", "india", "indonesia", "iran")

# plot the annual count of spells using a count of finishes per season assume season starts in August and condition on youth_team
spells |> 
  filter(staff_position=="manager") |> 
  mutate(season_start = ifelse(month(Start) < 8, year(Start), year(Start) + 1)) |>
  group_by(season_start,Answer_1) |>
  count(season_start)  |> 
  ggplot(aes(x = season_start, y = n, fill=Answer_1)) +
  geom_col(width = 0.5) +
  labs(title = "", x = "Season", y = "Number of spells") +
  theme_minimal() -> spell_count
plotly::ggplotly(spell_count)
```

# Methodology

A primary objective when modeling panel data grouped by country, sports leagues, seasons or other categories is allowing for and assessing systematic differences in effects across groups. Standard panel data techniques like fixed effects or random effects models enable some degree of heterogeneity by permitting intercept variation across groups @greene2003econometric. However, these approaches constrain slope coefficients and error variances to be constant. This could overlook meaningful group-level distributions in parameters beyond intercepts.

Hierarchical Bayesian (HB) models instead provide a cohesive framework for directly specifying group-level distributions for any parameters that may logically vary across categories @gelman2013bayesian. Hierarchical Bayesian (HB) models allow both individual and group-level estimates through partial pooling across the model hierarchy. The group-level distributions essentially serve as priors that regularize or shrink the extreme individual-level parameter estimates towards the group mean. At the same time, the group-level estimates themselves are still informed by and capture the cohort and contextual influences from the individual data.

So partial pooling provides a balanced trade-off - it shrinks less stable individual estimates to avoid overfitting, while still allowing the group distributions to represent meaningful variation across cohorts, contexts or other structures in the data. The key idea is that partial pooling up the hierarchy uses the group-level distributions to stabilize and strengthen estimates, while retaining the ability to capture subgroup patterns.

Moreover, HB models facilitate incorporating complex covariance patterns and nonlinear relationships in parameters across groups. @zhang2021racial uses Bayesian cross-classified multilevel analysis to model subtle temporal and group-level interactions in voter turnout - difficult to formulate through panel data methods.

In summary, HB techniques yield a unified modeling approach to characterize inter-group parameter variation. The methodology subsumes traditional panel data econometrics through its flexibility while addressing limitations. The formal probability structure also regulates instability and provides natural group-level effect quantification - particularly critical when data within clusters is sparse. This establishes hierarchical Bayesian modeling as a powerful tool for econometric grouped data analyses.

## Model Specification

The models are:

1.  **HB Logit Model**

$$P(\text{Poached}_{i} = 1 | \text{Points}_{i}, \text{RSI}_{i}) = \mathrm{logit}^{-1}(\alpha_{l[i]} + \beta_{1,l[i]} \text{Points}_{i} + \beta_{2,l[i]} \text{RSI}_{i} + \epsilon_{i})$$

2.  **HB Proportional Hazard Model**

$$h(t|X_{i}) = h_{0}(t)\exp(\alpha_{l[i]} + \beta_{1,l[i]} \text{Points}_{i} + \beta_{2,l[i]} \text{RSI}_{i}) $$

The $t$ is the time to hazard in games in charges. The subscript $l[i]$ allows coefficient variation across groups. We investigate hierarchies across season, country and country-tier. Hierarchical priors on $\alpha,\beta$ parameters share data to obtain better estimates, even for new leagues or clubs.

# Results

## Baseline logit model

```{r}
#| label: baseline-logit
#| eval: false
# This code is set yo not run, to set to run change eval to eval: true
dfanal=read_csv("./data/df_anal_new.csv")
rstan_options(auto_write=TRUE)  
options(mc.cores=parallel::detectCores ()) # Run on multiple cores
#set_cmdstan_path(path="/home/barry/.cmdstan/cmdstan-2.33.1")
dfanal |> drop_na(event,Standardized_CumRS,Pct_of_Possible_Points_Won,Div,`Domestic Games in Charge`)
dfanal$games_to_event<-dfanal$`Domestic Games in Charge`
model <- brm(poach ~ 1 + Standardized_CumRS + Pct_of_Possible_Points_Won,
             data = dfanal,
             family = bernoulli(), # Specifies a logit model for binary outcome
             warmup = 1000, # Number of warmup iterations for the MCMC
             iter = 5000, # Total number of iterations for the MCMC
             chains = 4, # Number of chains
             cores = 4, # Number of cores for parallel execution
             control = list(adapt_delta = 0.95), # Control parameters for the NUTS sampler
             seed=5678)

end=Sys.time()
print(end-start)
model |> summary()

saveRDS(model ,"logit_poach_base.rds")

```

```{r}
logit_baseline |>
  rename("Points of of Possible"=b_Pct_of_Possible_Points_Won,
         "Cumulative Relative Strength"=b_Standardized_CumRS)
         
          |>
  pivot_longer(!.draw &!.iteration&!.chain,names_to = "fixed_effect",values_to = "draws")|>
  ggplot(aes(y = fixed_effect,
             x=draws)) +
  stat_slab() +
  labs(x="",
       title="Baseline model for probability of poaching",
       subtitle="Posterior probability distribution",
       y="Fixed Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/logit_baseline.png",width = 12,height = 8)  

  
```

```{r}
logit_baseline |>
  rename("Points of of Possible"=b_Pct_of_Possible_Points_Won,
         "Cumulative Relative Strength"=b_Standardized_CumRS)
  pivot_longer(!.draw&!.iteration&!.chain,names_to = "fixed_effect",values_to = "draws")|>
  ggplot(aes(y = fixed_effect,
             x=draws)) +
  stat_slab() +
  labs(x="",
       title="Baseline model for probability of poaching",
       subtitle="Posterior probability distribution",
       y="Fixed Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/logit_baseline.png",width = 12,height = 8)  

  
```

```{r}
logit |> 
  ungroup() |>
  select(cty_factor,.iteration,.chain,conditional_mean_CumRS,conditional_mean_Pcts_of_Possible) |>
  pivot_longer(!cty_factor&!.iteration&!.chain,names_to = "conditional_mean",values_to = "draws") |>  
  group_by(cty_factor,conditional_mean) |>
  mutate(global_mean=mean(draws)) |>
  ggplot(aes(x = reorder(cty_factor,global_mean),
             y=draws, 
             fill =conditional_mean)) +
  stat_slab() +
  labs(x="",
       title="Overall effect on probability of poaching",
       subtitle="Posterior probability distribution",
       y="Overall Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/logit_by_cty.png",width = 12,height = 8)  

```

## Baseline hazard model

## group level logit models

```{r}
logit_cty |> 
  ungroup() |>
  select(cty_factor,.iteration,.chain,conditional_mean_CumRS,conditional_mean_Pcts_of_Possible) |>
  pivot_longer(!cty_factor&!.iteration&!.chain,names_to = "conditional_mean",values_to = "draws") |>  
  group_by(cty_factor,conditional_mean) |>
  mutate(global_mean=mean(draws)) |>
  ggplot(aes(x = reorder(cty_factor,global_mean),
             y=draws, 
             fill =conditional_mean)) +
  stat_slab() +
  labs(x="",
       title="Overall effect on probability of poaching",
       subtitle="Posterior probability distribution",
       y="Overall Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/logit_by_cty.png",width = 12,height = 8) 

```

```{r}
logit_season |> 
  ungroup() |>
  select(Season,.iteration,.chain,conditional_mean_CumRS,conditional_mean_Pcts_of_Possible) |>
  pivot_longer(!Season&!.iteration&!.chain,names_to = "conditional_mean",values_to = "draws") |>
  mutate(first_year = as.numeric(map_chr(str_split(Season, "-"), ~ .x[1]))) |>
  ggplot(aes(x = reorder(Season,first_year),
             y=draws, 
             fill =conditional_mean)) +
  stat_slab() +
  labs(x="",
       title="Overall effects on the probability of poaching",
       subtitle="Posterior probabilities from a bayesian hierarchical model",
       y="Overall Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/logit_by_season.png",width = 12,height = 8)  
```

```{r}
logit_div |> 
  ungroup() |>
  select(Division,.iteration,.chain,conditional_mean_CumRS,conditional_mean_Pcts_of_Possible) |>
  pivot_longer(!Division &!.iteration&!.chain,names_to = "conditional_mean",values_to = "draws") |> 
   group_by(Division,conditional_mean) |>
  mutate(global_mean=mean(draws)) |>
  ggplot(aes(x = reorder(Division,global_mean),
             y=draws, 
             fill =conditional_mean)) +
  stat_slab() +
  labs(x="",
       title="Overall effects on the probability of poaching",
       subtitle="Posterior probabilities from a bayesian hierarchical model",
       y="Overall Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/logit_by_div.png",width = 12,height = 8)  
```

## group level hazard models

```{r}
hazard_cty |> 
  ungroup() |>
  select(cty_factor,.iteration,.chain,conditional_mean_CumRS,conditional_mean_Pcts_of_Possible) |>
  pivot_longer(!cty_factor&!.iteration&!.chain,names_to = "conditional_mean",values_to = "draws") |>  
  group_by(cty_factor,conditional_mean) |>
  mutate(global_mean=mean(draws)) |>
  ggplot(aes(x = reorder(cty_factor,global_mean),
             y=draws, 
             fill =conditional_mean)) +
  stat_slab() +
  labs(x="",
       title="Overall effect on poaching hazard rate",
       subtitle="Posterior probability distribution",
       y="Overall Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/hazard_by_cty.png",width = 12,height = 8)  

```

```{r}
hazard_season |> 
  ungroup() |>
  select(Season,.iteration,.chain,conditional_mean_CumRS,conditional_mean_Pcts_of_Possible) |>
  pivot_longer(!Season&!.iteration&!.chain,names_to = "conditional_mean",values_to = "draws") |>
  mutate(first_year = as.numeric(map_chr(str_split(Season, "-"), ~ .x[1]))) |>
  ggplot(aes(x = reorder(Season,first_year),
             y=draws, 
             fill =conditional_mean)) +
  stat_slab() +
  labs(x="",
       title="Overall effects on the probability of poaching",
       subtitle="Posterior probabilities from a bayesian hierarchical model",
       y="Overall Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/hazard_by_season.png",width = 12,height = 8)  
```

```{r}
hazard_div |> 
  ungroup() |>
  select(Division,.iteration,.chain,conditional_mean_CumRS,conditional_mean_Pcts_of_Possible) |>
  pivot_longer(!Division&!.iteration&!.chain,names_to = "conditional_mean",values_to = "draws") |>  
  group_by(Division,conditional_mean) |>
  mutate(global_mean=mean(draws)) |>
  ggplot(aes(x = reorder(Division,global_mean),
             y=draws, 
             fill =conditional_mean)) +
  stat_slab() +
  labs(x="",
       title="Overall effect on poaching hazard rate",
       subtitle="Posterior probability distribution",
       y="Overall Effect",fill="")  +
  theme(axis.text.x = element_text(angle = 45,hjust = 1),
        title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  scale_fill_discrete(labels=c("Cumulative Relative Strength","Points out of Possible Points"))
ggsave(filename = "./plots/hazard_by_div.png",width = 12,height = 8)  

```